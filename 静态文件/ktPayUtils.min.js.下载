let timeId=null;function ktWXPayment(type,userId,commodityId,totalFee,otherInfo,vipPackageId){this.type=type;this.userId=userId;this.commodityId=commodityId;this.totalFee=totalFee;this.otherInfo=otherInfo;this.vipPackageId=vipPackageId;this.qrCodeUrl=null;this.h5PayForm=null;this.h5PayUrl=null;this.paying=null;this.payClient=0;const that=this;this.unifiedOrder=function(successCallback,paySuccessCallback){const url=ktConfig.api.wxpayUnifiedOrder.replace('{type}',type);const currentUrl=window.location.protocol+"//"+window.location.host+""+window.location.pathname;const data={userId:this.userId,commodityId:this.commodityId,totalFee:this.totalFee,vipPackageId:this.vipPackageId,currentUrl:currentUrl,otherInfo:this.otherInfo};ktUtils.postJson(url,data,function(r){if(r.errorCode===ktConfig.request.okCode){let data=r.data;that.orderNo=data.orderNo;let commodityToken=data.commodityToken;let alipayH5VO=data.alipayH5VO;log('微信支付下单：订单号【',that.orderNo+'】');if(commodityToken){ktUtils.setCommodityToken(type,commodityToken)}if(data.payClient){that.payClient=data.payClient}if(data.qrCodeName){that.qrCodeUrl=kfc+'/comm/static/handle/'+data.qrCodeName}if(alipayH5VO){that.h5PayForm=alipayH5VO.form;that.h5PayUrl=alipayH5VO.url}successCallback(that.qrCodeUrl,that.h5PayUrl);clearInterval(timeId);if(that.payClient===0){that.queryOrderStatusPoll(paySuccessCallback)}}else{ktUtils.snakeMsg('下单发生异常，请重试！msg:'+r.msg)}})};this.queryOrderStatusPoll=function(successCallback){if(!this.orderNo){return ktUtils.snakeMsg('查询订单发生异常，orderNo为空！')}timeId=setInterval(()=>{if(that.paying==='success'){clearInterval(timeId);that.paying='';successCallback()}else if(that.paying==='fail'){clearInterval(timeId);ktUtils.snakeMsg('订单支付失败或已取消！')}log('轮询查询订单【'+that.orderNo+'】中~~~');that.checkPaymentDone()},2000)};this.checkPaymentDone=function(){$.ajax({type:'POST',url:ktConfig.api.queryOrderStatus.replace('{orderNo}',this.orderNo),success:function(r){if(r.errorCode===ktConfig.request.okCode){let orderStatus=r.data;switch(Number(orderStatus)){case 1:that.paying='paying';break;case 2:that.paying='success';break;default:that.paying='fail'}}else{ktUtils.snakeMsg('下单发生异常，请重试！msg:'+r.msg);that.paying='fail'}}})};this.cancelQueryPoll=function(){if(timeId){clearInterval(timeId);log('成功取消订单【'+that.orderNo+'】轮询查询！')}};this.getOrderNo=function(){return this.orderNo}}